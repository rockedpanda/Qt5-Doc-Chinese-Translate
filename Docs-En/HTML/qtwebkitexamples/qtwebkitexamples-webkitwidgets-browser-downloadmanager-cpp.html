<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>downloadmanager.cpp Example File | QtWebKitExamples 5.3</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
    <div class="main">
    <div class="main-rounded">
        <div class="navigationbar">
        <ul>
<li><a href="../qtdoc/index.html">Qt 5.3</a></li>
<li><a href="qtwebkitexamples-index.html">Qt WebKit Examples</a></li>
<li><a href="qtwebkitexamples-webkitwidgets-browser-example.html">Tab Browser</a></li>
<li>downloadmanager.cpp Example File</li>
<li id="buildversion">
Qt 5.3.1 Reference Documentation</li>
    </ul>
    </div>
</div>
<div class="content">
<div class="line">
<div class="content mainContent">
<h1 class="title">downloadmanager.cpp Example File</h1>
<span class="subtitle">webkitwidgets/browser/downloadmanager.cpp</span>
<!-- $$$webkitwidgets/browser/downloadmanager.cpp-description -->
<div class="descr"> <a name="details"></a>
<pre class="cpp"><span class="comment">/****************************************************************************
**
** Copyright (C) 2013 Digia Plc and/or its subsidiary(-ies).
** Contact: http://www.qt-project.org/legal
**
** This file is part of the demonstration applications of the Qt Toolkit.
**
** $QT_BEGIN_LICENSE:LGPL$
** Commercial License Usage
** Licensees holding valid commercial Qt licenses may use this file in
** accordance with the commercial license agreement provided with the
** Software or, alternatively, in accordance with the terms contained in
** a written agreement between you and Digia.  For licensing terms and
** conditions see http://qt.digia.com/licensing.  For further information
** use the contact form at http://qt.digia.com/contact-us.
**
** GNU Lesser General Public License Usage
** Alternatively, this file may be used under the terms of the GNU Lesser
** General Public License version 2.1 as published by the Free Software
** Foundation and appearing in the file LICENSE.LGPL included in the
** packaging of this file.  Please review the following information to
** ensure the GNU Lesser General Public License version 2.1 requirements
** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
**
** In addition, as a special exception, Digia gives you certain additional
** rights.  These rights are described in the Digia Qt LGPL Exception
** version 1.1, included in the file LGPL_EXCEPTION.txt in this package.
**
** GNU General Public License Usage
** Alternatively, this file may be used under the terms of the GNU
** General Public License version 3.0 as published by the Free Software
** Foundation and appearing in the file LICENSE.GPL included in the
** packaging of this file.  Please review the following information to
** ensure the GNU General Public License version 3.0 requirements will be
** met: http://www.gnu.org/copyleft/gpl.html.
**
**
** $QT_END_LICENSE$
**
****************************************************************************/</span>

<span class="preprocessor">#include &quot;downloadmanager.h&quot;</span>

<span class="preprocessor">#include &quot;autosaver.h&quot;</span>
<span class="preprocessor">#include &quot;browserapplication.h&quot;</span>
<span class="preprocessor">#include &quot;networkaccessmanager.h&quot;</span>

<span class="preprocessor">#include &lt;math.h&gt;</span>

<span class="preprocessor">#include &lt;QtCore/QMetaEnum&gt;</span>
<span class="preprocessor">#include &lt;QtCore/QSettings&gt;</span>

<span class="preprocessor">#include &lt;QtGui/QDesktopServices&gt;</span>
<span class="preprocessor">#include &lt;QtWidgets/QFileDialog&gt;</span>
<span class="preprocessor">#include &lt;QtWidgets/QHeaderView&gt;</span>
<span class="preprocessor">#include &lt;QtWidgets/QFileIconProvider&gt;</span>

<span class="preprocessor">#include &lt;QtCore/QDebug&gt;</span>

<span class="preprocessor">#include &lt;QWebSettings&gt;</span>

<span class="comment">/*!
    DownloadItem is a widget that is displayed in the download manager list.
    It moves the data from the QNetworkReply into the QFile as well
    as update the information/progressbar and report errors.
 */</span>
DownloadItem<span class="operator">::</span>DownloadItem(<span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span> <span class="operator">*</span>reply<span class="operator">,</span> bool requestFileName<span class="operator">,</span> <span class="type"><a href="../qtwidgets/qwidget.html">QWidget</a></span> <span class="operator">*</span>parent)
    : <span class="type"><a href="../qtwidgets/qwidget.html">QWidget</a></span>(parent)
    <span class="operator">,</span> m_reply(reply)
    <span class="operator">,</span> m_requestFileName(requestFileName)
    <span class="operator">,</span> m_bytesReceived(<span class="number">0</span>)
{
    setupUi(<span class="keyword">this</span>);
    <span class="type"><a href="../qtgui/qpalette.html">QPalette</a></span> p <span class="operator">=</span> downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>palette();
    p<span class="operator">.</span>setColor(<span class="type"><a href="../qtgui/qpalette.html">QPalette</a></span><span class="operator">::</span>Text<span class="operator">,</span> <span class="type"><a href="../qtcore/qt.html">Qt</a></span><span class="operator">::</span>darkGray);
    downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>setPalette(p);
    progressBar<span class="operator">-</span><span class="operator">&gt;</span>setMaximum(<span class="number">0</span>);
    tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>hide();
    connect(stopButton<span class="operator">,</span> SIGNAL(clicked())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(stop()));
    connect(openButton<span class="operator">,</span> SIGNAL(clicked())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(open()));
    connect(tryAgainButton<span class="operator">,</span> SIGNAL(clicked())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(tryAgain()));

    init();
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>init()
{
    <span class="keyword">if</span> (<span class="operator">!</span>m_reply)
        <span class="keyword">return</span>;

    <span class="comment">// attach to the m_reply</span>
    m_url <span class="operator">=</span> m_reply<span class="operator">-</span><span class="operator">&gt;</span>url();
    m_reply<span class="operator">-</span><span class="operator">&gt;</span>setParent(<span class="keyword">this</span>);
    connect(m_reply<span class="operator">,</span> SIGNAL(readyRead())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(downloadReadyRead()));
    connect(m_reply<span class="operator">,</span> SIGNAL(error(<span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NetworkError))<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> SLOT(error(<span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NetworkError)));
    connect(m_reply<span class="operator">,</span> SIGNAL(downloadProgress(<span class="type"><a href="../qtcore/qtglobal.html#qint64-typedef">qint64</a></span><span class="operator">,</span><span class="type"><a href="../qtcore/qtglobal.html#qint64-typedef">qint64</a></span>))<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> SLOT(downloadProgress(<span class="type"><a href="../qtcore/qtglobal.html#qint64-typedef">qint64</a></span><span class="operator">,</span><span class="type"><a href="../qtcore/qtglobal.html#qint64-typedef">qint64</a></span>)));
    connect(m_reply<span class="operator">,</span> SIGNAL(metaDataChanged())<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> SLOT(metaDataChanged()));
    connect(m_reply<span class="operator">,</span> SIGNAL(finished())<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> SLOT(finished()));

    <span class="comment">// reset info</span>
    downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>clear();
    progressBar<span class="operator">-</span><span class="operator">&gt;</span>setValue(<span class="number">0</span>);
    getFileName();

    <span class="comment">// start timer for the download estimation</span>
    m_downloadTime<span class="operator">.</span>start();

    <span class="keyword">if</span> (m_reply<span class="operator">-</span><span class="operator">&gt;</span>error() <span class="operator">!</span><span class="operator">=</span> <span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NoError) {
        error(m_reply<span class="operator">-</span><span class="operator">&gt;</span>error());
        finished();
    }
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>getFileName()
{
    <span class="type"><a href="../qtcore/qsettings.html">QSettings</a></span> settings;
    settings<span class="operator">.</span>beginGroup(QLatin1String(<span class="string">&quot;downloadmanager&quot;</span>));
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> defaultLocation <span class="operator">=</span> <span class="type"><a href="../qtcore/qstandardpaths.html">QStandardPaths</a></span><span class="operator">::</span>writableLocation(<span class="type"><a href="../qtcore/qstandardpaths.html">QStandardPaths</a></span><span class="operator">::</span>DesktopLocation);
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> downloadDirectory <span class="operator">=</span> settings<span class="operator">.</span>value(QLatin1String(<span class="string">&quot;downloadDirectory&quot;</span>)<span class="operator">,</span> defaultLocation)<span class="operator">.</span>toString();
    <span class="keyword">if</span> (<span class="operator">!</span>downloadDirectory<span class="operator">.</span>isEmpty())
        downloadDirectory <span class="operator">+</span><span class="operator">=</span> QLatin1Char(<span class="char">'/'</span>);

    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> defaultFileName <span class="operator">=</span> saveFileName(downloadDirectory);
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> fileName <span class="operator">=</span> defaultFileName;
    <span class="keyword">if</span> (m_requestFileName) {
        fileName <span class="operator">=</span> <span class="type"><a href="../qtwidgets/qfiledialog.html">QFileDialog</a></span><span class="operator">::</span>getSaveFileName(<span class="keyword">this</span><span class="operator">,</span> tr(<span class="string">&quot;Save File&quot;</span>)<span class="operator">,</span> defaultFileName);
        <span class="keyword">if</span> (fileName<span class="operator">.</span>isEmpty()) {
            m_reply<span class="operator">-</span><span class="operator">&gt;</span>close();
            fileNameLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(tr(<span class="string">&quot;Download canceled: %1&quot;</span>)<span class="operator">.</span>arg(<span class="type"><a href="../qtcore/qfileinfo.html">QFileInfo</a></span>(defaultFileName)<span class="operator">.</span>fileName()));
            <span class="keyword">return</span>;
        }
    }
    m_output<span class="operator">.</span>setFileName(fileName);
    fileNameLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(<span class="type"><a href="../qtcore/qfileinfo.html">QFileInfo</a></span>(m_output<span class="operator">.</span>fileName())<span class="operator">.</span>fileName());
    <span class="keyword">if</span> (m_requestFileName)
        downloadReadyRead();
}

<span class="type"><a href="../qtcore/qstring.html">QString</a></span> DownloadItem<span class="operator">::</span>saveFileName(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>directory) <span class="keyword">const</span>
{
    <span class="comment">// Move this function into QNetworkReply to also get file name sent from the server</span>
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> path <span class="operator">=</span> m_url<span class="operator">.</span>path();
    <span class="type"><a href="../qtcore/qfileinfo.html">QFileInfo</a></span> info(path);
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> baseName <span class="operator">=</span> info<span class="operator">.</span>completeBaseName();
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> endName <span class="operator">=</span> info<span class="operator">.</span>suffix();

    <span class="keyword">if</span> (baseName<span class="operator">.</span>isEmpty()) {
        baseName <span class="operator">=</span> QLatin1String(<span class="string">&quot;unnamed_download&quot;</span>);
        <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;DownloadManager:: downloading unknown file:&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> m_url;
    }
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> name <span class="operator">=</span> directory <span class="operator">+</span> baseName <span class="operator">+</span> QLatin1Char(<span class="char">'.'</span>) <span class="operator">+</span> endName;
    <span class="keyword">if</span> (<span class="type"><a href="../qtcore/qfile.html">QFile</a></span><span class="operator">::</span>exists(name)) {
        <span class="comment">// already exists, don't overwrite</span>
        <span class="type">int</span> i <span class="operator">=</span> <span class="number">1</span>;
        <span class="keyword">do</span> {
            name <span class="operator">=</span> directory <span class="operator">+</span> baseName <span class="operator">+</span> QLatin1Char(<span class="char">'-'</span>) <span class="operator">+</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span><span class="operator">::</span>number(i<span class="operator">+</span><span class="operator">+</span>) <span class="operator">+</span> QLatin1Char(<span class="char">'.'</span>) <span class="operator">+</span> endName;
        } <span class="keyword">while</span> (<span class="type"><a href="../qtcore/qfile.html">QFile</a></span><span class="operator">::</span>exists(name));
    }
    <span class="keyword">return</span> name;
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>stop()
{
    setUpdatesEnabled(<span class="keyword">false</span>);
    stopButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">false</span>);
    stopButton<span class="operator">-</span><span class="operator">&gt;</span>hide();
    tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">true</span>);
    tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>show();
    setUpdatesEnabled(<span class="keyword">true</span>);
    m_reply<span class="operator">-</span><span class="operator">&gt;</span>abort();
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>open()
{
    <span class="type"><a href="../qtcore/qfileinfo.html">QFileInfo</a></span> info(m_output);
    <span class="type"><a href="../qtcore/qurl.html">QUrl</a></span> url <span class="operator">=</span> <span class="type"><a href="../qtcore/qurl.html">QUrl</a></span><span class="operator">::</span>fromLocalFile(info<span class="operator">.</span>absolutePath());
    <span class="type"><a href="../qtgui/qdesktopservices.html">QDesktopServices</a></span><span class="operator">::</span>openUrl(url);
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>tryAgain()
{
    <span class="keyword">if</span> (<span class="operator">!</span>tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>isEnabled())
        <span class="keyword">return</span>;

    tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">false</span>);
    tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>setVisible(<span class="keyword">false</span>);
    stopButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">true</span>);
    stopButton<span class="operator">-</span><span class="operator">&gt;</span>setVisible(<span class="keyword">true</span>);
    progressBar<span class="operator">-</span><span class="operator">&gt;</span>setVisible(<span class="keyword">true</span>);

    <span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span> <span class="operator">*</span>r <span class="operator">=</span> BrowserApplication<span class="operator">::</span>networkAccessManager()<span class="operator">-</span><span class="operator">&gt;</span>get(<span class="type"><a href="../qtnetwork/qnetworkrequest.html">QNetworkRequest</a></span>(m_url));
    <span class="keyword">if</span> (m_reply)
        m_reply<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
    <span class="keyword">if</span> (m_output<span class="operator">.</span>exists())
        m_output<span class="operator">.</span>remove();
    m_reply <span class="operator">=</span> r;
    init();
    <span class="keyword">emit</span> statusChanged();
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>downloadReadyRead()
{
    <span class="keyword">if</span> (m_requestFileName <span class="operator">&amp;</span><span class="operator">&amp;</span> m_output<span class="operator">.</span>fileName()<span class="operator">.</span>isEmpty())
        <span class="keyword">return</span>;
    <span class="keyword">if</span> (<span class="operator">!</span>m_output<span class="operator">.</span>isOpen()) {
        <span class="comment">// in case someone else has already put a file there</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_requestFileName)
            getFileName();
        <span class="keyword">if</span> (<span class="operator">!</span>m_output<span class="operator">.</span>open(<span class="type"><a href="../qtcore/qiodevice.html">QIODevice</a></span><span class="operator">::</span>WriteOnly)) {
            downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(tr(<span class="string">&quot;Error opening save file: %1&quot;</span>)
                    <span class="operator">.</span>arg(m_output<span class="operator">.</span>errorString()));
            stopButton<span class="operator">-</span><span class="operator">&gt;</span>click();
            <span class="keyword">emit</span> statusChanged();
            <span class="keyword">return</span>;
        }
        <span class="keyword">emit</span> statusChanged();
    }
    <span class="keyword">if</span> (<span class="operator">-</span><span class="number">1</span> <span class="operator">=</span><span class="operator">=</span> m_output<span class="operator">.</span>write(m_reply<span class="operator">-</span><span class="operator">&gt;</span>readAll())) {
        downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(tr(<span class="string">&quot;Error saving: %1&quot;</span>)
                <span class="operator">.</span>arg(m_output<span class="operator">.</span>errorString()));
        stopButton<span class="operator">-</span><span class="operator">&gt;</span>click();
    }
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>error(<span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NetworkError)
{
    <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;DownloadItem::error&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> m_reply<span class="operator">-</span><span class="operator">&gt;</span>errorString() <span class="operator">&lt;</span><span class="operator">&lt;</span> m_url;
    downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(tr(<span class="string">&quot;Network Error: %1&quot;</span>)<span class="operator">.</span>arg(m_reply<span class="operator">-</span><span class="operator">&gt;</span>errorString()));
    tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">true</span>);
    tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>setVisible(<span class="keyword">true</span>);
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>metaDataChanged()
{
    <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;DownloadItem::metaDataChanged: not handled.&quot;</span>;
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>downloadProgress(<span class="type"><a href="../qtcore/qtglobal.html#qint64-typedef">qint64</a></span> bytesReceived<span class="operator">,</span> <span class="type"><a href="../qtcore/qtglobal.html#qint64-typedef">qint64</a></span> bytesTotal)
{
    m_bytesReceived <span class="operator">=</span> bytesReceived;
    <span class="keyword">if</span> (bytesTotal <span class="operator">=</span><span class="operator">=</span> <span class="operator">-</span><span class="number">1</span>) {
        progressBar<span class="operator">-</span><span class="operator">&gt;</span>setValue(<span class="number">0</span>);
        progressBar<span class="operator">-</span><span class="operator">&gt;</span>setMaximum(<span class="number">0</span>);
    } <span class="keyword">else</span> {
        progressBar<span class="operator">-</span><span class="operator">&gt;</span>setValue(bytesReceived);
        progressBar<span class="operator">-</span><span class="operator">&gt;</span>setMaximum(bytesTotal);
    }
    updateInfoLabel();
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>updateInfoLabel()
{
    <span class="keyword">if</span> (m_reply<span class="operator">-</span><span class="operator">&gt;</span>error() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NoError)
        <span class="keyword">return</span>;

    <span class="type"><a href="../qtcore/qtglobal.html#qint64-typedef">qint64</a></span> bytesTotal <span class="operator">=</span> progressBar<span class="operator">-</span><span class="operator">&gt;</span>maximum();
    bool running <span class="operator">=</span> <span class="operator">!</span>downloadedSuccessfully();

    <span class="comment">// update info label</span>
    <span class="type">double</span> speed <span class="operator">=</span> m_bytesReceived <span class="operator">*</span> <span class="number">1000.0</span> <span class="operator">/</span> m_downloadTime<span class="operator">.</span>elapsed();
    <span class="type">double</span> timeRemaining <span class="operator">=</span> ((<span class="type">double</span>)(bytesTotal <span class="operator">-</span> m_bytesReceived)) <span class="operator">/</span> speed;
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> timeRemainingString <span class="operator">=</span> tr(<span class="string">&quot;seconds&quot;</span>);
    <span class="keyword">if</span> (timeRemaining <span class="operator">&gt;</span> <span class="number">60</span>) {
        timeRemaining <span class="operator">=</span> timeRemaining <span class="operator">/</span> <span class="number">60</span>;
        timeRemainingString <span class="operator">=</span> tr(<span class="string">&quot;minutes&quot;</span>);
    }
    timeRemaining <span class="operator">=</span> floor(timeRemaining);

    <span class="comment">// When downloading the eta should never be 0</span>
    <span class="keyword">if</span> (timeRemaining <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>)
        timeRemaining <span class="operator">=</span> <span class="number">1</span>;

    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> info;
    <span class="keyword">if</span> (running) {
        <span class="type"><a href="../qtcore/qstring.html">QString</a></span> remaining;
        <span class="keyword">if</span> (bytesTotal <span class="operator">!</span><span class="operator">=</span> <span class="number">0</span>)
            remaining <span class="operator">=</span> tr(<span class="string">&quot;- %4 %5 remaining&quot;</span>)
            <span class="operator">.</span>arg(timeRemaining)
            <span class="operator">.</span>arg(timeRemainingString);
        info <span class="operator">=</span> tr(<span class="string">&quot;%1 of %2 (%3/sec) %4&quot;</span>)
            <span class="operator">.</span>arg(dataString(m_bytesReceived))
            <span class="operator">.</span>arg(bytesTotal <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span> <span class="operator">?</span> tr(<span class="string">&quot;?&quot;</span>) : dataString(bytesTotal))
            <span class="operator">.</span>arg(dataString((<span class="type">int</span>)speed))
            <span class="operator">.</span>arg(remaining);
    } <span class="keyword">else</span> {
        <span class="keyword">if</span> (m_bytesReceived <span class="operator">=</span><span class="operator">=</span> bytesTotal)
            info <span class="operator">=</span> dataString(m_output<span class="operator">.</span>size());
        <span class="keyword">else</span>
            info <span class="operator">=</span> tr(<span class="string">&quot;%1 of %2 - Stopped&quot;</span>)
                <span class="operator">.</span>arg(dataString(m_bytesReceived))
                <span class="operator">.</span>arg(dataString(bytesTotal));
    }
    downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(info);
}

<span class="type"><a href="../qtcore/qstring.html">QString</a></span> DownloadItem<span class="operator">::</span>dataString(<span class="type">int</span> size) <span class="keyword">const</span>
{
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> unit;
    <span class="keyword">if</span> (size <span class="operator">&lt;</span> <span class="number">1024</span>) {
        unit <span class="operator">=</span> tr(<span class="string">&quot;bytes&quot;</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (size <span class="operator">&lt;</span> <span class="number">1024</span><span class="operator">*</span><span class="number">1024</span>) {
        size <span class="operator">/</span><span class="operator">=</span> <span class="number">1024</span>;
        unit <span class="operator">=</span> tr(<span class="string">&quot;kB&quot;</span>);
    } <span class="keyword">else</span> {
        size <span class="operator">/</span><span class="operator">=</span> <span class="number">1024</span><span class="operator">*</span><span class="number">1024</span>;
        unit <span class="operator">=</span> tr(<span class="string">&quot;MB&quot;</span>);
    }
    <span class="keyword">return</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span>(QLatin1String(<span class="string">&quot;%1 %2&quot;</span>))<span class="operator">.</span>arg(size)<span class="operator">.</span>arg(unit);
}

bool DownloadItem<span class="operator">::</span>downloading() <span class="keyword">const</span>
{
    <span class="keyword">return</span> (progressBar<span class="operator">-</span><span class="operator">&gt;</span>isVisible());
}

bool DownloadItem<span class="operator">::</span>downloadedSuccessfully() <span class="keyword">const</span>
{
    <span class="keyword">return</span> (stopButton<span class="operator">-</span><span class="operator">&gt;</span>isHidden() <span class="operator">&amp;</span><span class="operator">&amp;</span> tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>isHidden());
}

<span class="type">void</span> DownloadItem<span class="operator">::</span>finished()
{
    progressBar<span class="operator">-</span><span class="operator">&gt;</span>hide();
    stopButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">false</span>);
    stopButton<span class="operator">-</span><span class="operator">&gt;</span>hide();
    m_output<span class="operator">.</span>close();
    updateInfoLabel();
    <span class="keyword">emit</span> statusChanged();
}

<span class="comment">/*!
    DownloadManager is a Dialog that contains a list of DownloadItems

    It is a basic download manager.  It only downloads the file, doesn't do BitTorrent,
    extract zipped files or anything fancy.
  */</span>
DownloadManager<span class="operator">::</span>DownloadManager(<span class="type"><a href="../qtwidgets/qwidget.html">QWidget</a></span> <span class="operator">*</span>parent)
    : <span class="type"><a href="../qtwidgets/qdialog.html">QDialog</a></span>(parent)
    <span class="operator">,</span> m_autoSaver(<span class="keyword">new</span> AutoSaver(<span class="keyword">this</span>))
    <span class="operator">,</span> m_manager(BrowserApplication<span class="operator">::</span>networkAccessManager())
    <span class="operator">,</span> m_iconProvider(<span class="number">0</span>)
    <span class="operator">,</span> m_removePolicy(Never)
{
    setupUi(<span class="keyword">this</span>);
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>setShowGrid(<span class="keyword">false</span>);
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>verticalHeader()<span class="operator">-</span><span class="operator">&gt;</span>hide();
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>horizontalHeader()<span class="operator">-</span><span class="operator">&gt;</span>hide();
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>setAlternatingRowColors(<span class="keyword">true</span>);
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>horizontalHeader()<span class="operator">-</span><span class="operator">&gt;</span>setStretchLastSection(<span class="keyword">true</span>);
    m_model <span class="operator">=</span> <span class="keyword">new</span> DownloadModel(<span class="keyword">this</span>);
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>setModel(m_model);
    connect(cleanupButton<span class="operator">,</span> SIGNAL(clicked())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(cleanup()));
    load();
}

DownloadManager<span class="operator">::</span><span class="operator">~</span>DownloadManager()
{
    m_autoSaver<span class="operator">-</span><span class="operator">&gt;</span>changeOccurred();
    m_autoSaver<span class="operator">-</span><span class="operator">&gt;</span>saveIfNeccessary();
    <span class="keyword">if</span> (m_iconProvider)
        <span class="keyword">delete</span> m_iconProvider;
}

<span class="type">int</span> DownloadManager<span class="operator">::</span>activeDownloads() <span class="keyword">const</span>
{
    <span class="type">int</span> count <span class="operator">=</span> <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> m_downloads<span class="operator">.</span>count(); <span class="operator">+</span><span class="operator">+</span>i) {
        <span class="keyword">if</span> (m_downloads<span class="operator">.</span>at(i)<span class="operator">-</span><span class="operator">&gt;</span>stopButton<span class="operator">-</span><span class="operator">&gt;</span>isEnabled())
            <span class="operator">+</span><span class="operator">+</span>count;
    }
    <span class="keyword">return</span> count;
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>download(<span class="keyword">const</span> <span class="type"><a href="../qtnetwork/qnetworkrequest.html">QNetworkRequest</a></span> <span class="operator">&amp;</span>request<span class="operator">,</span> bool requestFileName)
{
    <span class="keyword">if</span> (request<span class="operator">.</span>url()<span class="operator">.</span>isEmpty())
        <span class="keyword">return</span>;
    handleUnsupportedContent(m_manager<span class="operator">-</span><span class="operator">&gt;</span>get(request)<span class="operator">,</span> requestFileName);
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>handleUnsupportedContent(<span class="type"><a href="../qtnetwork/qnetworkreply.html">QNetworkReply</a></span> <span class="operator">*</span>reply<span class="operator">,</span> bool requestFileName)
{
    <span class="keyword">if</span> (<span class="operator">!</span>reply <span class="operator">|</span><span class="operator">|</span> reply<span class="operator">-</span><span class="operator">&gt;</span>url()<span class="operator">.</span>isEmpty())
        <span class="keyword">return</span>;
    <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span> header <span class="operator">=</span> reply<span class="operator">-</span><span class="operator">&gt;</span>header(<span class="type"><a href="../qtnetwork/qnetworkrequest.html">QNetworkRequest</a></span><span class="operator">::</span>ContentLengthHeader);
    bool ok;
    <span class="type">int</span> size <span class="operator">=</span> header<span class="operator">.</span>toInt(<span class="operator">&amp;</span>ok);
    <span class="keyword">if</span> (ok <span class="operator">&amp;</span><span class="operator">&amp;</span> size <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>)
        <span class="keyword">return</span>;

    <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;DownloadManager::handleUnsupportedContent&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> reply<span class="operator">-</span><span class="operator">&gt;</span>url() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;requestFileName&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> requestFileName;
    DownloadItem <span class="operator">*</span>item <span class="operator">=</span> <span class="keyword">new</span> DownloadItem(reply<span class="operator">,</span> requestFileName<span class="operator">,</span> <span class="keyword">this</span>);
    addItem(item);
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>addItem(DownloadItem <span class="operator">*</span>item)
{
    connect(item<span class="operator">,</span> SIGNAL(statusChanged())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(updateRow()));
    <span class="type">int</span> row <span class="operator">=</span> m_downloads<span class="operator">.</span>count();
    m_model<span class="operator">-</span><span class="operator">&gt;</span>beginInsertRows(<span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span>()<span class="operator">,</span> row<span class="operator">,</span> row);
    m_downloads<span class="operator">.</span>append(item);
    m_model<span class="operator">-</span><span class="operator">&gt;</span>endInsertRows();
    updateItemCount();
    <span class="keyword">if</span> (row <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>)
        show();
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>setIndexWidget(m_model<span class="operator">-</span><span class="operator">&gt;</span>index(row<span class="operator">,</span> <span class="number">0</span>)<span class="operator">,</span> item);
    <span class="type"><a href="../qtgui/qicon.html">QIcon</a></span> icon <span class="operator">=</span> style()<span class="operator">-</span><span class="operator">&gt;</span>standardIcon(<span class="type"><a href="../qtwidgets/qstyle.html">QStyle</a></span><span class="operator">::</span>SP_FileIcon);
    item<span class="operator">-</span><span class="operator">&gt;</span>fileIcon<span class="operator">-</span><span class="operator">&gt;</span>setPixmap(icon<span class="operator">.</span>pixmap(<span class="number">48</span><span class="operator">,</span> <span class="number">48</span>));
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>setRowHeight(row<span class="operator">,</span> item<span class="operator">-</span><span class="operator">&gt;</span>sizeHint()<span class="operator">.</span>height());
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>updateRow()
{
    DownloadItem <span class="operator">*</span>item <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>DownloadItem<span class="operator">*</span><span class="operator">&gt;</span>(sender());
    <span class="type">int</span> row <span class="operator">=</span> m_downloads<span class="operator">.</span>indexOf(item);
    <span class="keyword">if</span> (<span class="operator">-</span><span class="number">1</span> <span class="operator">=</span><span class="operator">=</span> row)
        <span class="keyword">return</span>;
    <span class="keyword">if</span> (<span class="operator">!</span>m_iconProvider)
        m_iconProvider <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="../qtwidgets/qfileiconprovider.html">QFileIconProvider</a></span>();
    <span class="type"><a href="../qtgui/qicon.html">QIcon</a></span> icon <span class="operator">=</span> m_iconProvider<span class="operator">-</span><span class="operator">&gt;</span>icon(item<span class="operator">-</span><span class="operator">&gt;</span>m_output<span class="operator">.</span>fileName());
    <span class="keyword">if</span> (icon<span class="operator">.</span>isNull())
        icon <span class="operator">=</span> style()<span class="operator">-</span><span class="operator">&gt;</span>standardIcon(<span class="type"><a href="../qtwidgets/qstyle.html">QStyle</a></span><span class="operator">::</span>SP_FileIcon);
    item<span class="operator">-</span><span class="operator">&gt;</span>fileIcon<span class="operator">-</span><span class="operator">&gt;</span>setPixmap(icon<span class="operator">.</span>pixmap(<span class="number">48</span><span class="operator">,</span> <span class="number">48</span>));
    downloadsView<span class="operator">-</span><span class="operator">&gt;</span>setRowHeight(row<span class="operator">,</span> item<span class="operator">-</span><span class="operator">&gt;</span>minimumSizeHint()<span class="operator">.</span>height());

    bool remove <span class="operator">=</span> <span class="keyword">false</span>;
    <span class="type"><a href="../qtwebkit/qwebsettings.html">QWebSettings</a></span> <span class="operator">*</span>globalSettings <span class="operator">=</span> <span class="type"><a href="../qtwebkit/qwebsettings.html">QWebSettings</a></span><span class="operator">::</span>globalSettings();
    <span class="keyword">if</span> (<span class="operator">!</span>item<span class="operator">-</span><span class="operator">&gt;</span>downloading()
        <span class="operator">&amp;</span><span class="operator">&amp;</span> globalSettings<span class="operator">-</span><span class="operator">&gt;</span>testAttribute(<span class="type"><a href="../qtwebkit/qwebsettings.html">QWebSettings</a></span><span class="operator">::</span>PrivateBrowsingEnabled))
        remove <span class="operator">=</span> <span class="keyword">true</span>;

    <span class="keyword">if</span> (item<span class="operator">-</span><span class="operator">&gt;</span>downloadedSuccessfully()
        <span class="operator">&amp;</span><span class="operator">&amp;</span> removePolicy() <span class="operator">=</span><span class="operator">=</span> DownloadManager<span class="operator">::</span>SuccessFullDownload) {
        remove <span class="operator">=</span> <span class="keyword">true</span>;
    }
    <span class="keyword">if</span> (remove)
        m_model<span class="operator">-</span><span class="operator">&gt;</span>removeRow(row);

    cleanupButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(m_downloads<span class="operator">.</span>count() <span class="operator">-</span> activeDownloads() <span class="operator">&gt;</span> <span class="number">0</span>);
}

DownloadManager<span class="operator">::</span>RemovePolicy DownloadManager<span class="operator">::</span>removePolicy() <span class="keyword">const</span>
{
    <span class="keyword">return</span> m_removePolicy;
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>setRemovePolicy(RemovePolicy policy)
{
    <span class="keyword">if</span> (policy <span class="operator">=</span><span class="operator">=</span> m_removePolicy)
        <span class="keyword">return</span>;
    m_removePolicy <span class="operator">=</span> policy;
    m_autoSaver<span class="operator">-</span><span class="operator">&gt;</span>changeOccurred();
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>save() <span class="keyword">const</span>
{
    <span class="type"><a href="../qtcore/qsettings.html">QSettings</a></span> settings;
    settings<span class="operator">.</span>beginGroup(QLatin1String(<span class="string">&quot;downloadmanager&quot;</span>));
    <span class="type"><a href="../qtcore/qmetaenum.html">QMetaEnum</a></span> removePolicyEnum <span class="operator">=</span> staticMetaObject<span class="operator">.</span>enumerator(staticMetaObject<span class="operator">.</span>indexOfEnumerator(<span class="string">&quot;RemovePolicy&quot;</span>));
    settings<span class="operator">.</span>setValue(QLatin1String(<span class="string">&quot;removeDownloadsPolicy&quot;</span>)<span class="operator">,</span> QLatin1String(removePolicyEnum<span class="operator">.</span>valueToKey(m_removePolicy)));
    settings<span class="operator">.</span>setValue(QLatin1String(<span class="string">&quot;size&quot;</span>)<span class="operator">,</span> size());
    <span class="keyword">if</span> (m_removePolicy <span class="operator">=</span><span class="operator">=</span> Exit)
        <span class="keyword">return</span>;

    <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> m_downloads<span class="operator">.</span>count(); <span class="operator">+</span><span class="operator">+</span>i) {
        <span class="type"><a href="../qtcore/qstring.html">QString</a></span> key <span class="operator">=</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span>(QLatin1String(<span class="string">&quot;download_%1_&quot;</span>))<span class="operator">.</span>arg(i);
        settings<span class="operator">.</span>setValue(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;url&quot;</span>)<span class="operator">,</span> m_downloads<span class="operator">[</span>i<span class="operator">]</span><span class="operator">-</span><span class="operator">&gt;</span>m_url);
        settings<span class="operator">.</span>setValue(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;location&quot;</span>)<span class="operator">,</span> <span class="type"><a href="../qtcore/qfileinfo.html">QFileInfo</a></span>(m_downloads<span class="operator">[</span>i<span class="operator">]</span><span class="operator">-</span><span class="operator">&gt;</span>m_output)<span class="operator">.</span>filePath());
        settings<span class="operator">.</span>setValue(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;done&quot;</span>)<span class="operator">,</span> m_downloads<span class="operator">[</span>i<span class="operator">]</span><span class="operator">-</span><span class="operator">&gt;</span>downloadedSuccessfully());
    }
    <span class="type">int</span> i <span class="operator">=</span> m_downloads<span class="operator">.</span>count();
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> key <span class="operator">=</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span>(QLatin1String(<span class="string">&quot;download_%1_&quot;</span>))<span class="operator">.</span>arg(i);
    <span class="keyword">while</span> (settings<span class="operator">.</span>contains(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;url&quot;</span>))) {
        settings<span class="operator">.</span>remove(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;url&quot;</span>));
        settings<span class="operator">.</span>remove(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;location&quot;</span>));
        settings<span class="operator">.</span>remove(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;done&quot;</span>));
        key <span class="operator">=</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span>(QLatin1String(<span class="string">&quot;download_%1_&quot;</span>))<span class="operator">.</span>arg(<span class="operator">+</span><span class="operator">+</span>i);
    }
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>load()
{
    <span class="type"><a href="../qtcore/qsettings.html">QSettings</a></span> settings;
    settings<span class="operator">.</span>beginGroup(QLatin1String(<span class="string">&quot;downloadmanager&quot;</span>));
    <span class="type"><a href="../qtcore/qsize.html">QSize</a></span> size <span class="operator">=</span> settings<span class="operator">.</span>value(QLatin1String(<span class="string">&quot;size&quot;</span>))<span class="operator">.</span>toSize();
    <span class="keyword">if</span> (size<span class="operator">.</span>isValid())
        resize(size);
    <span class="type"><a href="../qtcore/qbytearray.html">QByteArray</a></span> value <span class="operator">=</span> settings<span class="operator">.</span>value(QLatin1String(<span class="string">&quot;removeDownloadsPolicy&quot;</span>)<span class="operator">,</span> QLatin1String(<span class="string">&quot;Never&quot;</span>))<span class="operator">.</span>toByteArray();
    <span class="type"><a href="../qtcore/qmetaenum.html">QMetaEnum</a></span> removePolicyEnum <span class="operator">=</span> staticMetaObject<span class="operator">.</span>enumerator(staticMetaObject<span class="operator">.</span>indexOfEnumerator(<span class="string">&quot;RemovePolicy&quot;</span>));
    m_removePolicy <span class="operator">=</span> removePolicyEnum<span class="operator">.</span>keyToValue(value) <span class="operator">=</span><span class="operator">=</span> <span class="operator">-</span><span class="number">1</span> <span class="operator">?</span>
                        Never :
                        <span class="keyword">static_cast</span><span class="operator">&lt;</span>RemovePolicy<span class="operator">&gt;</span>(removePolicyEnum<span class="operator">.</span>keyToValue(value));

    <span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>;
    <span class="type"><a href="../qtcore/qstring.html">QString</a></span> key <span class="operator">=</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span>(QLatin1String(<span class="string">&quot;download_%1_&quot;</span>))<span class="operator">.</span>arg(i);
    <span class="keyword">while</span> (settings<span class="operator">.</span>contains(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;url&quot;</span>))) {
        <span class="type"><a href="../qtcore/qurl.html">QUrl</a></span> url <span class="operator">=</span> settings<span class="operator">.</span>value(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;url&quot;</span>))<span class="operator">.</span>toUrl();
        <span class="type"><a href="../qtcore/qstring.html">QString</a></span> fileName <span class="operator">=</span> settings<span class="operator">.</span>value(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;location&quot;</span>))<span class="operator">.</span>toString();
        bool done <span class="operator">=</span> settings<span class="operator">.</span>value(key <span class="operator">+</span> QLatin1String(<span class="string">&quot;done&quot;</span>)<span class="operator">,</span> <span class="keyword">true</span>)<span class="operator">.</span>toBool();
        <span class="keyword">if</span> (<span class="operator">!</span>url<span class="operator">.</span>isEmpty() <span class="operator">&amp;</span><span class="operator">&amp;</span> <span class="operator">!</span>fileName<span class="operator">.</span>isEmpty()) {
            DownloadItem <span class="operator">*</span>item <span class="operator">=</span> <span class="keyword">new</span> DownloadItem(<span class="number">0</span><span class="operator">,</span> <span class="keyword">this</span>);
            item<span class="operator">-</span><span class="operator">&gt;</span>m_output<span class="operator">.</span>setFileName(fileName);
            item<span class="operator">-</span><span class="operator">&gt;</span>fileNameLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(<span class="type"><a href="../qtcore/qfileinfo.html">QFileInfo</a></span>(item<span class="operator">-</span><span class="operator">&gt;</span>m_output<span class="operator">.</span>fileName())<span class="operator">.</span>fileName());
            item<span class="operator">-</span><span class="operator">&gt;</span>m_url <span class="operator">=</span> url;
            item<span class="operator">-</span><span class="operator">&gt;</span>stopButton<span class="operator">-</span><span class="operator">&gt;</span>setVisible(<span class="keyword">false</span>);
            item<span class="operator">-</span><span class="operator">&gt;</span>stopButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">false</span>);
            item<span class="operator">-</span><span class="operator">&gt;</span>tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>setVisible(<span class="operator">!</span>done);
            item<span class="operator">-</span><span class="operator">&gt;</span>tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="operator">!</span>done);
            item<span class="operator">-</span><span class="operator">&gt;</span>progressBar<span class="operator">-</span><span class="operator">&gt;</span>setVisible(<span class="operator">!</span>done);
            addItem(item);
        }
        key <span class="operator">=</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span>(QLatin1String(<span class="string">&quot;download_%1_&quot;</span>))<span class="operator">.</span>arg(<span class="operator">+</span><span class="operator">+</span>i);
    }
    cleanupButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(m_downloads<span class="operator">.</span>count() <span class="operator">-</span> activeDownloads() <span class="operator">&gt;</span> <span class="number">0</span>);
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>cleanup()
{
    <span class="keyword">if</span> (m_downloads<span class="operator">.</span>isEmpty())
        <span class="keyword">return</span>;
    m_model<span class="operator">-</span><span class="operator">&gt;</span>removeRows(<span class="number">0</span><span class="operator">,</span> m_downloads<span class="operator">.</span>count());
    updateItemCount();
    <span class="keyword">if</span> (m_downloads<span class="operator">.</span>isEmpty() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_iconProvider) {
        <span class="keyword">delete</span> m_iconProvider;
        m_iconProvider <span class="operator">=</span> <span class="number">0</span>;
    }
    m_autoSaver<span class="operator">-</span><span class="operator">&gt;</span>changeOccurred();
}

<span class="type">void</span> DownloadManager<span class="operator">::</span>updateItemCount()
{
    <span class="type">int</span> count <span class="operator">=</span> m_downloads<span class="operator">.</span>count();
    itemCount<span class="operator">-</span><span class="operator">&gt;</span>setText(count <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span> <span class="operator">?</span> tr(<span class="string">&quot;1 Download&quot;</span>) : tr(<span class="string">&quot;%1 Downloads&quot;</span>)<span class="operator">.</span>arg(count));
}

DownloadModel<span class="operator">::</span>DownloadModel(DownloadManager <span class="operator">*</span>downloadManager<span class="operator">,</span> <span class="type"><a href="../qtcore/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
    : <span class="type"><a href="../qtcore/qabstractlistmodel.html">QAbstractListModel</a></span>(parent)
    <span class="operator">,</span> m_downloadManager(downloadManager)
{
}

<span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span> DownloadModel<span class="operator">::</span>data(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index<span class="operator">,</span> <span class="type">int</span> role) <span class="keyword">const</span>
{
    <span class="keyword">if</span> (index<span class="operator">.</span>row() <span class="operator">&lt;</span> <span class="number">0</span> <span class="operator">|</span><span class="operator">|</span> index<span class="operator">.</span>row() <span class="operator">&gt;</span><span class="operator">=</span> rowCount(index<span class="operator">.</span>parent()))
        <span class="keyword">return</span> <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span>();
    <span class="keyword">if</span> (role <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="../qtcore/qt.html">Qt</a></span><span class="operator">::</span>ToolTipRole)
        <span class="keyword">if</span> (<span class="operator">!</span>m_downloadManager<span class="operator">-</span><span class="operator">&gt;</span>m_downloads<span class="operator">.</span>at(index<span class="operator">.</span>row())<span class="operator">-</span><span class="operator">&gt;</span>downloadedSuccessfully())
            <span class="keyword">return</span> m_downloadManager<span class="operator">-</span><span class="operator">&gt;</span>m_downloads<span class="operator">.</span>at(index<span class="operator">.</span>row())<span class="operator">-</span><span class="operator">&gt;</span>downloadInfoLabel<span class="operator">-</span><span class="operator">&gt;</span>text();
    <span class="keyword">return</span> <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span>();
}

<span class="type">int</span> DownloadModel<span class="operator">::</span>rowCount(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>parent) <span class="keyword">const</span>
{
    <span class="keyword">return</span> (parent<span class="operator">.</span>isValid()) <span class="operator">?</span> <span class="number">0</span> : m_downloadManager<span class="operator">-</span><span class="operator">&gt;</span>m_downloads<span class="operator">.</span>count();
}

bool DownloadModel<span class="operator">::</span>removeRows(<span class="type">int</span> row<span class="operator">,</span> <span class="type">int</span> count<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>parent)
{
    <span class="keyword">if</span> (parent<span class="operator">.</span>isValid())
        <span class="keyword">return</span> <span class="keyword">false</span>;

    <span class="type">int</span> lastRow <span class="operator">=</span> row <span class="operator">+</span> count <span class="operator">-</span> <span class="number">1</span>;
    <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> lastRow; i <span class="operator">&gt;</span><span class="operator">=</span> row; <span class="operator">-</span><span class="operator">-</span>i) {
        <span class="keyword">if</span> (m_downloadManager<span class="operator">-</span><span class="operator">&gt;</span>m_downloads<span class="operator">.</span>at(i)<span class="operator">-</span><span class="operator">&gt;</span>downloadedSuccessfully()
            <span class="operator">|</span><span class="operator">|</span> m_downloadManager<span class="operator">-</span><span class="operator">&gt;</span>m_downloads<span class="operator">.</span>at(i)<span class="operator">-</span><span class="operator">&gt;</span>tryAgainButton<span class="operator">-</span><span class="operator">&gt;</span>isEnabled()) {
            beginRemoveRows(parent<span class="operator">,</span> i<span class="operator">,</span> i);
            m_downloadManager<span class="operator">-</span><span class="operator">&gt;</span>m_downloads<span class="operator">.</span>takeAt(i)<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
            endRemoveRows();
        }
    }
    m_downloadManager<span class="operator">-</span><span class="operator">&gt;</span>m_autoSaver<span class="operator">-</span><span class="operator">&gt;</span>changeOccurred();
    <span class="keyword">return</span> <span class="keyword">true</span>;
}</pre>
</div>
<!-- @@@webkitwidgets/browser/downloadmanager.cpp -->
        </div>
       </div>
   </div>
   </div>
</div>
<div class="footer">
   <p>
   <acronym title="Copyright">&copy;</acronym> 2014 Digia Plc and/or its
   subsidiaries. Documentation contributions included herein are the copyrights of
   their respective owners.<br>    The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the Free Software Foundation.<br>    Digia, Qt and their respective logos are trademarks of Digia Plc     in Finland and/or other countries worldwide. All other trademarks are property
   of their respective owners. </p>
</div>
</body>
</html>
